<script>
  import { eventBus, events } from '$lib/eventBus';

  export let header = 'Dynamic List';
  export let entries = [];
  if (entries === null || entries === undefined || !Array.isArray(entries) || entries.length === 0) {
    entries = [
      { text: '', level: 0 },
      { text: '', level: 0 },
      { text: '', level: 0 },
    ];
  }

  function addEntry() {
    entries.push({ text: '', level: 0 });
    entries = entries; // Svelte reactivity for bind
    eventBus.emit(events.SHEET_DATA_CHANGED, entries);
  }

  function removeEntry(idx) {
    entries.splice(idx, 1);
    entries = entries; // Svelte reactivity for bind
    eventBus.emit(events.SHEET_DATA_CHANGED, entries);
  }

  function updateText(idx, value) {
    entries[idx].text = value;
    eventBus.emit(events.SHEET_DATA_CHANGED, entries);
  }

  function updateLevel(idx, value) {
    entries[idx].level = value;
    eventBus.emit(events.SHEET_DATA_CHANGED, entries);
  }
</script>

<div class="flex flex-col relative border rounded-xl border-black pb-2 pt-4 px-3">
  <div class="absolute left-0 right-0 -top-3 flex justify-center">
    <div class="w-fit text-center bg-background-0 font-rampart-spurs tracking-wider px-1">{header}</div>
  </div>

  <div class="w-full space-y-2">
    {#each entries as entry, idx (idx)}
      <div class="flex items-center gap-2 w-full">
        <input type="text" bind:value={entry.text} on:input={(e) => updateText(idx, e.target.value)} placeholder="Entry text" />
        <div class="flex gap-1">
          {#each [1, 2, 3, 4, 5] as i (i)}
            <button
              type="button"
              class="w-3 h-3 rounded-full flex items-center justify-center cursor-pointer hover:!bg-tprimary-0 {i <= entry.level ? '!bg-tprimary-0' : '!bg-background-500'}"
              on:click={() => updateLevel(idx, i + 1)}
              title={`Set level to ${i + 1}`}
              aria-label={`Set level to ${i + 1}`}
            >
            </button>
          {/each}
        </div>
        <button
          class="flex align-center justify-center w-6 h-4 !bg-red-900 hover:!bg-red-700 rounded-full text-xs"
          on:click={() => removeEntry(idx)}
          disabled={entries.length <= 1}
          title="Remove entry">-</button
        >
      </div>
    {/each}
  </div>
  <button class="mt-2 px-2 pt-1 rounded text-xs hover:!bg-dark-blue-0" on:click={addEntry}>+ Add Entry</button>
</div>
